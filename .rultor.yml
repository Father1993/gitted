# SPDX-FileCopyrightText: Copyright (c) 2025 Yegor Bugayenko
# SPDX-License-Identifier: MIT
---
# yamllint disable rule:line-length
docker:
  image: yegor256/python
assets:
  twine_token: yegor256/home#assets/twine_token
install: |
  pdd -f /dev/null
  pip install --progress-bar=off -r requirements.txt
release:
  pre: false
  script: |-
    [[ "${tag}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] || exit -1
    sed -i "s/0\.0\.0/${tag}/g" pyproject.toml
    git add pyproject.toml
    sed -i "s/0\.0\.0/${tag}/g" src/gitted/__init__.py
    git add src/gitted/__init__.py
    for f in $(find scripts -type f); do sed -i "s/0\.0\.0/${tag}/g" "${f}"; git add "${f}"; done
    git commit -m "version set to ${tag}"
    pip install --progress-bar=off uv
    GITTED_BATCH=true GITTED_TESTING=true make -e
    uv --color=never build --no-build-logs
    uv --color=never run python -m twine upload dist/* -u __token__ -p $(cat ../twine_token)
merge:
  script: |-
    GITTED_BATCH=true GITTED_TESTING=true make -e
