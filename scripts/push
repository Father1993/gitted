#!/bin/bash
# SPDX-FileCopyrightText: Copyright (c) 2025 Yegor Bugayenko
# SPDX-License-Identifier: MIT

# shellcheck disable=SC1091
. "$(dirname "$0")/../sub-scripts/commons.sh"

# shellcheck disable=SC1091
. "$(dirname "$0")/../sub-scripts/intro.sh"

# shellcheck disable=SC1091
. "$(dirname "$0")/../sub-scripts/sanity.sh"

# shellcheck disable=SC2154
"${base}/pull" "$*"

# shellcheck disable=SC2154
"${base}/commit" "$*"

branch=$(git symbolic-ref HEAD --short)

attempt=1
max=10
while true; do
    title_it "Pushing to origin/${branch} (attempt no.${attempt}/${max})"
    bash_it "${GIT_BIN}" push origin "${branch}" && break
    if [ -n "${GITTED_TESTING}" ]; then
        exit 1
    fi
    attempt=$((attempt + 1))
    if [ "${attempt}" -gt "${max}" ]; then
        exit 1
    fi
done
